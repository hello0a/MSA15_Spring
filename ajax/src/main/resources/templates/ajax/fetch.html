<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fetch</title>
</head>

<body>
    <h1>fetch</h1>

    <h5>게시글 조회</h5>
    <label for="no">게시글 번호</label>
    <input type="text" name="no" id="no">
    <button onclick="getBoard()">조회</button>
    <hr>
    <div>
        <h5>조회된 게시글 정보</h5>
        <h3><span>제목 : </span><span id="title"></span></h3>
        <h3><span>작성자 : </span><span id="writer"></span></h3>
        <textarea id="content" cols="50" rows="10" readonly></textarea>
    </div>
    <!-- 서버에서 받은 JSON 데이터 여기에 출력 -->
    <hr>
    <h3>게시글 등록/수정/삭제</h3>
    <form action="/api/boards" method="post">
        <table>
            <tr>
                <td><label for="title">제목</label></td>
                <td><input type="text" name="title" id="input-title"></td>
            </tr>
            <tr>
                <td><label for="writer">작성자</label></td>
                <td><input type="text" name="writer" id="input-writer"></td>
            </tr>
            <tr>
                <td><label for="content">내용</label></td>
                <td>
                    <textarea name="content" id="input-content" cols="50" rows="10"></textarea>
                </td>
            </tr>
            <tr>
                <td><label for="updateNo">글번호</label></td>
                <td><input type="text" name="no" id="input-no" placeholder="수정/삭제 번호"></td>
            </tr>
        </table>
        <button type="button" onclick="insert()">등록하기</button>
        <button type="button" onclick="update()">수정하기</button>
        <button type="button" onclick="remove()">삭제하기</button>
        <!-- delete 는 js 예약어 있으므로 설정할 수 없으니, remove 사용 -->
    </form>
    <hr>
    <h3>게시글 목록</h3>
    <table id="board-list" border="1">
        <tr id="board-title">
            <th width="50">번호</th>
            <th width="300">제목</th>
            <th width="100">작성자</th>
            <th width="200">등록일자</th>
            <th width="200">수정일자</th>
        </tr>
        <tbody id="board-body">
            <tr id="board-data">
                <td colspan="5" align="center">조회된 데이터가 없습니다.</td>
            </tr>
        </tbody>
        <!-- 나중에 JS에서 실제 데이터로 바뀜 -->
    </table>

    <div style="height: 1000px;"></div>
<!-- 전체 구조 설명
    : HTML 화면에서 버튼 누르면 JS -> Spring (서버) 요청 보내고 -> 서버 응답 (JSON) 받아 화면에 표시 -->
    <script>
        let request
        // 전역 변수
        // : AJAX 요청 보낼 때 사용할 fetch 객체 담을 변수

        //게시글 조회
        function getBoard() {

            // 입력한 글 번호 가져오기
            let no = document.getElementById("no").value

            // 요청 설정
            let url = `http://127.0.0.1:8080/api/boards/${no}`

            // FETCH API 로 게시글 조회요청
            fetch(url)  // Promise 객체 반환 (then 메서드 정의O)
                // then() : 서버로부터 응답 왔을 때 호출되는 메서드
                // reponse : 상태 코드, 헤더, 본문 등의 응답 객체 정보
                .then(response => {
                    // 요청 성공
                    if (response.ok) {
                        // JSON 문자열 -> JS 객체 변환
                        return response.json()
                    } else {
                        console.log(response.status)
                        alert('데이터 조회에 실패했습니다.')
                        throw new Error('조회 실패')
                    }
                })
                .then( board => {
                    if(!board) {
                        alert("응답된 데이터가 없습니다.")
                    } else {
                        let title = document.getElementById("title")
                        let writer = document.getElementById("writer")
                        let content = document.getElementById("content")

                        title.textContent = board.title
                        writer.textContent = board.writer
                        content.textContent = board.content
                    }
                })
                // catch() : 에러 발생했을 때 실행
                .catch (error => {
                    console.log(error)
                    console.dir(error)
                    alert('게시글 조회 요청 중 에러가 발생했습니다.')
                })
        }

        // 게시글 목록 조회
        function getList() {

            // 요청 설정
            let url = `http://127.0.0.1:8080/api/boards`
            
            // FETCH API 로 게시글 목록 요청
            fetch(url) 
                .then(response => {
                    if(response.ok) {
                        // JSON 문자열 -> JS 객체로 변환
                        return response.json()
                    } else {
                        throw new Error('목록 조회 실패')
                    }
                })
                .then( boardList => {
                    // 데이터가 없을 때
                    if (boardList.length == 0) {
                    altert ('응답된 데이터 없습니다.')
                    } else {
                        // 데이터 있을 때
                        let $boardBody = document.getElementById('board-body')
                        
                        // 데이터 초기화
                        $boardBody.innerHTML = ''

                        let tr = ''
                        for( const board of boardList ) {
                            tr += `<tr>
                                    <td>${board.no}</td>
                                    <td>${board.title}</td>
                                    <td>${board.writer}</td>
                                    <td>${board.createdAt}</td>
                                    <td>${board.updatedAt}</td>
                                  </tr>`
                            // 기존 innerHTML 이어서 tr 태그 추가
                            // : board-list 아래로 추가되는 것!
                        }
                        $boardBody.innerHTML = tr
                    }
                })
        }
        // 게시글 목록 함수 호출
        getList()

        // 게시글 등록
        function insert() {

            // 입력 정보
            // 바닐라 JS 래!
            let title = document.getElementById("input-title").value
            let writer = document.getElementById("input-writer").value
            let content = document.getElementById("input-content").value

            // 객체
            let data = {
                'title' : title,
                'writer' : writer,
                'content' : content,
            }

            // 요청 설정
            let url = `http://127.0.0.1:8080/api/boards`

            // FETCH API 로 게시글 등록 요청
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type' : 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                return response.text().then(result => ({
                    status: response.status,
                    result: result
                }))
                // status : 201 / result: success
                // 묵었더 data로 넘기기
            })
            .then(data => {
                if( data.status == 201 ) {
                    alert(data.result)
                    // result : success
                    getList()
                }else if( data.status == 400) {
                    alert('클라이언트의 잘못된 요청')
                }else if( data.status == 500) {
                    alert('서버 내부 에러')
                }
            })
            .catch(error => {
                log.error('Error: ', error)
                alert('게시글 등록 중 에러가 발생했습니다.')
            })
        }

        // 게시글 수정
        function update() {

            // 입력 정보
            let no = document.getElementById("input-no").value
            let title = document.getElementById("input-title").value
            let writer = document.getElementById("input-writer").value
            let content = document.getElementById("input-content").value

            // 객체
            let data = {
                'no' : no,
                'title' : title,
                'writer' : writer,
                'content' : content
            }

            // 요청 설정
            let url = `http://127.0.0.1:8080/api/boards`

            // FETCH API 로 게시글 수정 요청
            fetch(url, {
                method: 'PUT',
                headers: { 'Content-Type' : 'application/json'},
                body : JSON.stringify(data)
            })
            .then(response => {
                return response.text().then(result => ({
                    status: response.status,
                    result: result
                }))
                // status : 201 / result: success
                // 묵었더 data로 넘기기
            })
            .then(data => {
                if( data.status == 200 ) {
                    alert(data.result)
                    // result : success
                    getList()
                }else if( data.status == 400) {
                    alert('클라이언트의 잘못된 요청')
                }else if( data.status == 500) {
                    alert('서버 내부 에러')
                }
            })
            .catch(error => {
                log.error('Error: ', error)
                alert('게시글 수정 중 에러가 발생했습니다.')
            })
        }
        // 게시글 삭제하기
        function remove() {

            // 입력정보
            let no = document.getElementById('input-no').value            

            // DELETE 요청 방식은 요청 데이터를 URL에 포함하여 전송 (GET 방식 동일)
            // 요청 설정
            let url = `http://127.0.0.1:8080/api/boards/${no}`

            // FETCH API
            fetch(url, {
                method: 'DELETE',
            })
            .then(response => {
                return response.text().then(result => ({
                    status: response.status,
                    result: result
                }))
                // status : 201 / result: success
                // 묵었더 data로 넘기기
            })
            .then(data => {
                if( data.status == 200 ) {
                    alert(data.result)
                    // result : success
                    getList()
                }else if( data.status == 400) {
                    alert('클라이언트의 잘못된 요청')
                }else if( data.status == 500) {
                    alert('서버 내부 에러')
                }
            })
            .catch(error => {
                log.error('Error: ', error)
                alert('게시글 삭제 중 에러가 발생했습니다.')
            })   
        }
    </script>
</body>
</html>
<!-- 꼭 이해해야할 핵심 요약
    1. fetch : 서버와 통신하는 옛날 방식의 AJAX 도구
        -> Fetch API 나오기 전 방식
    2. 서버의 응답은 무조건 "문자열(JSON)"
        -> JSON.parse() 로 JS 객체로 바꿔야 사용 가능
    3. 서버로 데이터 보낼 때는 객체를 바로 못 보냄
        -> JSON.stringify() 해야함
    4. Content-Type 꼭 지정해야 서버가 JSON 임을 알 수 있음
        -> request.setRequestHeader("Content-Type", "application/json") 
    5. 응답 성공 시 onload 에서 처리
    
    ** 서버 : 스프링부트 / 클라이언트 : 사용자-->
    