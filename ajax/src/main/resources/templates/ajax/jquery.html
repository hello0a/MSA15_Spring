<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jQuery</title>
</head>

<body>
    <h1>jQuery</h1>

    <h5>게시글 조회</h5>
    <label for="no">게시글 번호</label>
    <input type="text" name="no" id="no">
    <button onclick="getBoard()">조회</button>
    <hr>
    <div>
        <h5>조회된 게시글 정보</h5>
        <h3><span>제목 : </span><span id="title"></span></h3>
        <h3><span>작성자 : </span><span id="writer"></span></h3>
        <textarea id="content" cols="50" rows="10" readonly></textarea>
    </div>
    <!-- 서버에서 받은 JSON 데이터 여기에 출력 -->
    <hr>
    <h3>게시글 등록/수정/삭제</h3>
    <form action="/api/boards" method="post">
        <table>
            <tr>
                <td><label for="title">제목</label></td>
                <td><input type="text" name="title" id="input-title"></td>
            </tr>
            <tr>
                <td><label for="writer">작성자</label></td>
                <td><input type="text" name="writer" id="input-writer"></td>
            </tr>
            <tr>
                <td><label for="content">내용</label></td>
                <td>
                    <textarea name="content" id="input-content" cols="50" rows="10"></textarea>
                </td>
            </tr>
            <tr>
                <td><label for="updateNo">글번호</label></td>
                <td><input type="text" name="no" id="input-no" placeholder="수정/삭제 번호"></td>
            </tr>
        </table>
        <button type="button" onclick="insert()">등록하기</button>
        <button type="button" onclick="update()">수정하기</button>
        <button type="button" onclick="remove()">삭제하기</button>
        <!-- delete 는 js 예약어 있으므로 설정할 수 없으니, remove 사용 -->
    </form>
    <hr>
    <h3>게시글 목록</h3>
    <table id="board-list" border="1">
        <tr id="board-title">
            <th width="50">번호</th>
            <th width="300">제목</th>
            <th width="100">작성자</th>
            <th width="200">등록일자</th>
            <th width="200">수정일자</th>
        </tr>
        <tbody id="board-body">
            <tr id="board-data">
                <td colspan="5" align="center">조회된 데이터가 없습니다.</td>
            </tr>
        </tbody>
        <!-- 나중에 JS에서 실제 데이터로 바뀜 -->
    </table>

    <div style="height: 1000px;"></div>

    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        let request
        // 전역 변수
        // : AJAX 요청 보낼 때 사용할 fetch 객체 담을 변수

        //게시글 조회
        function getBoard() {

            // 입력한 글 번호 가져오기
            let no = document.getElementById("no").value

            // 요청 설정
            let url = `http://127.0.0.1:8080/api/boards/${no}`

            // jQuery AJAX 로 게시글 조회 요청
            $.ajax({
                url: url,
                method : 'GET',
                dataType : 'json',
                success : function(board) {
                    if (!board) {
                        alert('응답된 데이터가 없습니다')
                    } else {
                        $('#title').text(board.title)
                        $('#writer').text(board.writer)
                        $('#content').text(board.content)
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error: ', error)
                    alert('데이터 조회에 실패했습니다.')
                }
            })
        }

        // 게시글 목록 조회
        function getList() {

            // 요청 설정
            let url = `http://127.0.0.1:8080/api/boards`
            
            // jQuery AJAX 로 게시글 목록 요청
            $.ajax({
                url: url,
                method : 'GET',
                dataType : 'json',      // 서버가 JSON 줄 거라는 의미!
                // GET 요청 특징
                // : 서버에 나 데이터 좀 줘! 라고 요청할 때 사용
                // -> 서버에 전송하는 데이터 사실상 없음
                // -> 필요하면 URL 뒤에 ?no=5 같은 쿼리스트링 으로 조금 붙일 뿐!
                // 즉, 서버에게 보낼 body(본문) 없다!
                // 그래서!
                // contentType (보낼 내용 타입) / data (보낼 데이터) 필요 없음
                // 그 대신!
                // dataType (서버가 어떤 타입으로 데이터를 보내줄지 알려줄 필요는 있음!)
                success : function(boardList) {
                    if (boardList.length == 0) {
                        alert('응답된 데이터가 없습니다')
                    } else {
                        // 데이터 초기화
                        // : 없으면 기존 5개부터 다시 누적됨
                        // 1. 기존 목록 All 제거
                        // 2. 새로운 서버 데이터 요청
                        // 3. 받은 데이터 기반으로 <tr> 다시 생성
                        // 4. 깨끗한 상태의 <tbody> 다시 뿌림
                        $('#board-body').empty()

                        let tr = ''
                        for(const board of boardList) {
                            tr += `<tr>
                                     <td>${board.no}</td>
                                     <td>${board.title}</td>
                                     <td>${board.writer}</td>
                                     <td>${board.createdAt}</td>
                                     <td>${board.updatedAt}</td>
                                </tr>`
                        }
                        $('#board-body').html(tr)
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error: ', error)
                    alert('데이터 조회에 실패했습니다.')
                }
            })
        }
        // 게시글 목록 함수 호출
        getList()

        // 게시글 등록
        function insert() {

            // 입력 정보
            let title = $("#input-title").val()
            let writer = $("#input-writer").val()
            let content = $("#input-content").val()

            // 객체
            let data = {
                'title' : title,
                'writer' : writer,
                'content' : content,
            }

            // 요청 설정
            let url = `http://127.0.0.1:8080/api/boards`

            // jQuery AJAX 로 게시글 등록 요청
            $.ajax({
                url : url,
                method : 'POST',
                contentType : 'application/json',
                data : JSON.stringify(data),
                // POST/PUT/DELETE 요청 특징
                // : 서버에 데이터 보내는 것이 목적
                // -> 서버에 보낼 데이터가 존재하므로 **반드시** 2가지 필요
                // 1. 보내는 데이터의 형태 알려주는 contentType
                // -> 내가 보내는 데이터는 JSON 방식이야!
                // 2. 실제로 보낼 데이터 data
                // -> 이게 서버로 전달됨
                success : function(result, status, xhr) {
                    alert(result)
                    getList()
                },
                error: function(xhr, status, error) {
                    if(xhr.status == 400) {
                        alert('클라이언트의 잘못된 요청')
                    } else if (xhr.status == 500) {
                        alert('서버 내부 에러')
                    } else {
                        console.error('Error: ', error)
                        alert('게시글 등록 중 에러가 발생하였습니다.')
                    }
                }
            })
        }

        // 게시글 수정
        function update() {

            // 입력 정보
            let no = $("#input-no").val()
            let title = $("#input-title").val()
            let writer = $("#input-writer").val()
            let content = $("#input-content").val()

            // 객체
            let data = {
                'no' : no,
                'title' : title,
                'writer' : writer,
                'content' : content
            }

            // 요청 설정
            let url = `http://127.0.0.1:8080/api/boards`

            // jQuery AJAX 로 게시글 등록 요청
            $.ajax({
                url : url,
                method : 'PUT',
                contentType : 'application/json',
                data : JSON.stringify(data),
                success : function(result, status, xhr) {
                    alert(result)
                    getList()
                },
                error: function(xhr, status, error) {
                    if(xhr.status == 400) {
                        alert('클라이언트의 잘못된 요청')
                    } else if (xhr.status == 500) {
                        alert('서버 내부 에러')
                    } else {
                        console.error('Error: ', error)
                        alert('게시글 수정 중 에러가 발생하였습니다.')
                    }
                }
            })
            
        }
        // 게시글 삭제하기
        function remove() {

            // 입력정보
            let no = $('#input-no').val()            

            // DELETE 요청 방식은 요청 데이터를 URL에 포함하여 전송 (GET 방식 동일)
            // 요청 설정
            let url = `http://127.0.0.1:8080/api/boards/${no}`

            // jQuery AJAX 로 게시글 등록 요청
            $.ajax({
                url : url,
                method : 'DELETE',
                success : function(result, status, xhr) {
                // 괄호 안 순서 고정!
                // : 마음대로 바꾸면 값 엉뚱하게 들어오거나 undefined 됌
                // -> 왜 중요한가?
                // successCallback(responseData, textStatus, jqXHR)
                // -> jQuery 내부에서 success 콜백을 호출할 때 이렇게 호출함!
                // -> 순서 바꾸면 의도와 완전히 다른 값 들어가서 코드 오작동 및 깨짐!
                // 즉, 이름은 바꿔도 순서는 유지하기!
                    alert(result)
                    getList()
                },
                error: function(xhr, status, error) {
                    if(xhr.status == 400) {
                        alert('클라이언트의 잘못된 요청')
                    } else if (xhr.status == 500) {
                        alert('서버 내부 에러')
                    } else {
                        console.error('Error: ', error)
                        alert('게시글 수정 중 에러가 발생하였습니다.')
                    }
                }
            })
        }
    </script>
</body>
</html>
<!-- 요청 비유
    GET = 우체부에게 편지 받는 것!
    - 내가 우체부한테 아무것도 안 줌
    - 우체부(서버)가 나에게 무엇을 줄지만 정하면 됨
    - 그래서 "받을 편지의 종류(dataType)"

    POST/PUT = 내가 우체국에 편지 보내는 것
    - 보낼 편지(data) 가 반드시 들어있음
    - 이 편지는 이런 형식(contentType) 이야! 라고 알려줘야 함
    - 편지를 넣어서(data) 보내야 함
-->

    