<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.min.css" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-fileinput@5.5.3/css/fileinput.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <title>ê²Œì‹œíŒ í”„ë¡œì íŠ¸</title>
</head>
<body>
    <main>
       <div class="container py-5">
        <!-- row : flex ì§€ì • -->
            <div class="row justify-content-center">
                <!-- ìµœëŒ€ 12ì¡°ê°, ëª¨ë°”ì¼ë¡œ 10ì¡°ê°, pxë¡œ 6ì¡°ê°ë§Œ ì‚¬ìš©í•œë‹¤~! -->
                <div class="col-12 col-md-10 col-lg-10">
                    <h1 class="text-center">ê²Œì‹œê¸€ ìˆ˜ì •</h1>
                    <!-- th:object="${board}" ê°ì²´ ë“±ë¡ ì‹œ ê·¸ í•˜ìœ„ëŠ” í•„ë“œë§Œ ë‹´ìœ¼ë©´ OK! id, name, th:valueê¹Œì§€ ë„£ì–´ì¤€ ê²ƒ! -->
                    <form id="form" action="/board/update" method="post" th:object="${board}" enctype="multipart/form-data">
                        <input type="hidden" th:field="*{no}">
                        <div class="mb-3">
                            <label for="" class="form-label">ì œëª©</label>
                            <input type="text" class="form-control" th:field="*{title}"
                                aria-describedby="helpTitle" placeholder="ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" />
                        </div>
                        <div class="mb-3">
                            <label for="" class="form-label">ì‘ì„±ì</label>
                            <input type="text" class="form-control" th:field="*{writer}"
                                aria-describedby="helpWriter" placeholder="ì‘ì„±ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" />
                        </div>
                        <div class="mb-3">
                            <label for="" class="form-label">ë‚´ìš©</label>
                            <textarea class="form-control" th:field="*{content}" rows="5" ></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="" class="form-label">íŒŒì¼ëª©ë¡</label>
                            <input type="file" id="file1" class="file" multiple/>
                        </div>
                        <div class="mb-3">
                            <label for="" class="form-label">ì²¨ë¶€íŒŒì¼</label>
                            <input type="file" id="file2" class="file" name="files" multiple/>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-center mt-2">
                            <button type="submit" class="btn btn-primary w-100">ìˆ˜ì •</button>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-center mt-2">
                            <button type="button" class="btn btn-outline-primary w-100" onclick="moveList()">ëª©ë¡</button>
                            <button type="button" class="btn btn-outline-danger w-100" onclick="actionDelete()">ì‚­ì œ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

    <!-- íŒŒì¼ ì•„ì´í…œ ìˆœì„œë³€ê²½ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.5.0/js/plugins/sortable.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-fileinput@5.5.3/js/fileinput.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-fi
    leinput@5.5.3/themes/fas/theme.min.js"></script>
    <script src="/js/locales/kr.js"></script>
    <script>
        // ì—…ë°ì´íŠ¸ no (ëª¨ë¸ ê°ì²´) ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ê°€ì ¸ì˜¤ëŠ” ë°©ë²•
        // ìë°” ë™ì‘ í›„ ìë°”ìŠ¤í¬ë¦½íŠ¸ ë™ì‘
        let no = '[[${board.no}]]'
        // í¼
        let $form = document.getElementById("form")
        // ëª©ë¡ í™”ë©´ ì´ë™
        function moveList() {
            location.href = '/board/list'
        }
        // ì‚­ì œ ìš”ì²­
        function actionDelete() {
            let check = confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')
            if (check) {
                $form.action = '/board/delete'
                $form.submit()
            }
        }
    </script>
    <script th:inline="javascript">
        // ë™ê¸°ì‹ìœ¼ë¡œ ê°€ì ¸ì˜¨ íŒŒì¼ ëª©ë¡ ë°ì´í„°
        //  : Java ê°ì²´ -> JS ê°ì²´
        // ì•„ë˜ ë¹„ë™ê¸° ìš”ì²­ ë° ì´ˆê¸°í™” ì•ˆí•œë‹¤ë©´?
        // board.java ì— ì´ë¯¸ ë“¤ì–´ìˆë‹¤...?
        // : ëŒ€ê´„í˜¸ ì–‘ìª½ì— ë¶™ì—¬ì£¼ë©´ java List<File> -> js ë°°ì—´ë¡œ ë°”ë€œ!
        let fileList = [[${board.fileList}]]

        // íŒŒì¼ ëª©ë¡ ë¹„ë™ê¸° ìš”ì²­ ë° ì´ˆê¸°í™”
       async function loadFiles() {
        try {
            // ë¹„ë™ê¸° ìš”ì²­ìœ¼ë¡œ ê°€ì ¸ì˜¨ íŒŒì¼ëª©ë¡ ë°ì´í„°
            // const response = await fetch(`/files/board/${no}`);
            // const data = await response.json();
            // data : íŒŒì¼ ë¦¬ìŠ¤íŠ¸ ë°°ì—´
            const data = fileList

            console.log(data);

            let initialPreview = [];
            let initialPreviewConfig = [];

            data.forEach(file => {
                let fileUrl = '/files/' + file.id;

                initialPreview.push(fileUrl);

                initialPreviewConfig.push({
                    caption: file.name,
                    size: file.size,
                    width: "120px",
                    url: '/files/' + file.id,
                    key: file.id
                });
            });

            // ğŸ”´ ì¤‘ìš”: ê¸°ì¡´ fileinput ì œê±°
            if ($("#file1").data('fileinput')) {
                $("#file1").fileinput('destroy');
            }

            // íŒŒì¼ ì—…ë¡œë“œ ì´ˆê¸°í™”
            $("#file1").fileinput({
                language: "kr",                               // ì–¸ì–´ ì„¤ì •          
                initialPreview: initialPreview,               // ë¯¸ë¦¬ë³´ê¸°í•  íŒŒì¼ì˜ URL ë°°ì—´
                initialPreviewAsData: true,                   // â˜… URLì„ ì´ë¯¸ì§€/íŒŒì¼ë¡œ ì¸ì‹
                initialPreviewConfig: initialPreviewConfig,   // ë¯¸ë¦¬ë³´ê¸° ì„¤ì •
                // initialPreviewShowDelete: false,              // íŒŒì¼ë³„ ì‚­ì œë²„íŠ¼ ìˆ¨ê¹€
                showUpload: false,                            // ì—…ë¡œë“œ ë²„íŠ¼ ìˆ¨ê¹€
                showRemove: false,                            // ì „ì²´ ì‚­ì œë²„íŠ¼ ìˆ¨ê¹€
                showBrowse: false,                            // íŒŒì¼ ì°¾ì•„ë³´ê¸° ë²„íŠ¼ ìˆ¨ê¹€
                showCaption: false,                           // íŒŒì¼ ìº¡ì…˜ ìˆ¨ê¹€
                showClose: false,                              // ë¯¸ë¦¬ë³´ê¸° ë‹«ê¸° ë²„íŠ¼ ìˆ¨ê¹€
                ajaxDeleteSettings: {
                    type: "DELETE"  
                }
            })
            // íŒŒì¼ ìˆœì„œ ë³€ê²½ ì´ë²¤íŠ¸
            .on('filesorted', function(event, params) {
                // params.stack : ì •ë ¬ëœ íŒŒì¼ ë°°ì—´
                // params.newIndex : ì´ë™ í›„ ì¸ë±ìŠ¤
                // params.oldIndex : ì´ë™ ì „ ì¸ë±ìŠ¤
                console.log('íŒŒì¼ ìˆœì„œ ë³€ê²½ : ', params);
                console.log('New index : ', params.newIndex);
                console.log('Old index : ', params.oldIndex);
                console.log('ì •ë ¬ëœ ë°°ì—´ : ', params.stack);

                // ìˆœì„œ ë³€ê²½ ë¹„ë™ê¸° ìš”ì²­
                fetch('/files/sort', {
                    method : 'PUT',
                    headers : {'Content-Type' : 'application/json'},
                    body : JSON.stringify(params.stack)
                }).then(response => {
                    console.log(response);
                }).catch(error => {
                    console.error('Error : ', error);
                })
            })
            ;

        } catch (error) {
            console.error("íŒŒì¼ ë¡œë”© ì‹¤íŒ¨", error);
        }
    }

    // DOM ì¤€ë¹„ í›„ ì‹¤í–‰
    $(document).ready(function () {
      loadFiles();
    });
    </script>
    <!-- ì²¨ë¶€ íŒŒì¼ -->
    <script>
        $("#file2").fileinput({
            theme: "fas",
            language: "kr",        // ì–¸ì–´ ì½”ë“œë¡œ ì„¤ì •
            showUpload: false,      // AJAX ì—…ë¡œë“œ ë²„íŠ¼ ìˆ¨ê¹€ (ì¤‘ìš”)
            showRemove: true,
            browseLabel: "íŒŒì¼ ì„ íƒ",
           // allowedFileExtensions: ["jpg", "png", "pdf"],
            maxFileSize: 10240,     // 10MB (KB ë‹¨ìœ„)
            maxFileCount: 10
        });
    </script>
</body>
</html>